<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solo Dungeon Master - AD&D 1st Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&family=Orbitron:wght@400;500;600;700;800;900&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Modern Gaming Color Palette */
            --primary: #00d4ff;
            --primary-dark: #0099cc;
            --primary-darker: #006b8f;
            --secondary: #8b5cf6;
            --secondary-dark: #6d28d9;
            --accent: #ec4899;
            --accent-alt: #f59e0b;

            /* Backgrounds */
            --bg-darkest: #050812;
            --bg-dark: #0a0e1a;
            --bg-medium: #131823;
            --bg-light: #1a1f2e;
            --bg-lighter: #232938;

            /* Text Colors */
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --text-cyan: #00d4ff;
            --text-purple: #a78bfa;

            /* Borders */
            --border-dark: #1e293b;
            --border-light: #334155;
            --border-glow: #00d4ff;

            /* Status Colors */
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;

            /* Effects */
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.4);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.5);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.6);
            --shadow-glow: 0 0 20px rgba(0, 212, 255, 0.3);
            --shadow-glow-purple: 0 0 20px rgba(139, 92, 246, 0.3);
            --shadow-glow-pink: 0 0 20px rgba(236, 72, 153, 0.3);
        }

        body {
            font-family: 'Rajdhani', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-darkest);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            background-image:
                radial-gradient(circle at 20% 50%, rgba(0, 212, 255, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(236, 72, 153, 0.03) 0%, transparent 50%),
                linear-gradient(180deg, var(--bg-darkest) 0%, var(--bg-dark) 100%);
            background-attachment: fixed;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Header Styles */
        header {
            text-align: center;
            padding: 2.5rem 2rem;
            background: linear-gradient(135deg, var(--bg-medium), var(--bg-light));
            border: 1px solid var(--border-light);
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg), inset 0 1px 0 rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary), var(--secondary), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        h1 {
            font-size: 3rem;
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 50%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(0, 212, 255, 0.5);
            margin-bottom: 0.5rem;
            letter-spacing: 3px;
            filter: drop-shadow(0 0 10px rgba(0, 212, 255, 0.3));
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 500;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* Button Styles */
        .btn {
            padding: 0.85rem 1.75rem;
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            color: var(--text-primary);
            border: 1px solid var(--primary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'Rajdhani', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            box-shadow: var(--shadow-md), 0 0 0 0 rgba(0, 212, 255, 0.5);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            box-shadow: var(--shadow-lg), var(--shadow-glow), 0 0 0 3px rgba(0, 212, 255, 0.2);
            transform: translateY(-2px);
            border-color: var(--text-cyan);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--bg-lighter), var(--bg-light));
            border-color: var(--border-light);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, var(--bg-light), var(--bg-medium));
            border-color: var(--secondary);
            box-shadow: var(--shadow-lg), var(--shadow-glow-purple);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc2626, var(--danger));
            border-color: var(--danger);
        }

        .btn-danger:hover {
            box-shadow: var(--shadow-lg), 0 0 20px rgba(239, 68, 68, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #059669, var(--success));
            border-color: var(--success);
        }

        .btn-success:hover {
            box-shadow: var(--shadow-lg), 0 0 20px rgba(16, 185, 129, 0.4);
        }

        /* Card Styles */
        .card {
            background: linear-gradient(135deg, var(--bg-medium), var(--bg-light));
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 1.75rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            opacity: 0.5;
        }

        .card:hover {
            border-color: var(--border-glow);
            box-shadow: var(--shadow-lg), var(--shadow-glow);
        }

        .card-title {
            font-size: 1.6rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--text-cyan), var(--text-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 0.75rem;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-cyan);
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.85rem 1rem;
            background: var(--bg-dark);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: 'Rajdhani', sans-serif;
            transition: all 0.3s;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3), 0 0 0 3px rgba(0, 212, 255, 0.1), var(--shadow-glow);
            background: var(--bg-medium);
        }

        input::placeholder {
            color: var(--text-muted);
        }

        /* Screen Management */
        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Login Screen */
        .login-container {
            max-width: 500px;
            margin: 100px auto;
        }

        /* Main Menu */
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .menu-card {
            background: linear-gradient(135deg, var(--bg-medium), var(--bg-light));
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .menu-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.1), transparent);
            transition: left 0.5s;
        }

        .menu-card:hover::before {
            left: 100%;
        }

        .menu-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-lg), var(--shadow-glow);
            border-color: var(--primary);
        }

        .menu-card-icon {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            filter: drop-shadow(0 0 10px rgba(0, 212, 255, 0.5));
        }

        .menu-card-title {
            font-size: 1.4rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--text-cyan), var(--text-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .menu-card-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Character Creation */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .stat-box {
            background: linear-gradient(135deg, var(--bg-dark), var(--bg-medium));
            border: 1px solid var(--border-light);
            border-radius: 10px;
            padding: 1.25rem;
            text-align: center;
            box-shadow: var(--shadow-md);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            opacity: 0.6;
        }

        .stat-box:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg), var(--shadow-glow);
            border-color: var(--primary);
        }

        .stat-label {
            color: var(--text-cyan);
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 2.5rem;
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0.25rem 0;
        }

        .stat-modifier {
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* Game Session */
        .game-layout {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .character-panel {
            background: linear-gradient(135deg, var(--bg-medium), var(--bg-light));
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 1.75rem;
            height: fit-content;
            position: sticky;
            top: 1rem;
            box-shadow: var(--shadow-md);
        }

        .game-area {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .narrative-box {
            background: var(--bg-dark);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 1.75rem;
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.4), var(--shadow-md);
        }

        .narrative-entry {
            margin-bottom: 1.5rem;
            padding: 1.25rem;
            background: linear-gradient(135deg, var(--bg-medium), var(--bg-light));
            border-left: 3px solid var(--secondary);
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s;
            position: relative;
        }

        .narrative-entry:hover {
            transform: translateX(4px);
            box-shadow: var(--shadow-md);
        }

        .narrative-dm {
            border-left-color: var(--secondary);
        }

        .narrative-player {
            border-left-color: var(--primary);
            background: linear-gradient(135deg, var(--bg-light), var(--bg-lighter));
        }

        .narrative-system {
            border-left-color: var(--accent);
            font-style: italic;
            background: linear-gradient(135deg, var(--bg-dark), var(--bg-medium));
        }

        /* AI Indicator Badge */
        .ai-badge {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.75rem;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.15), rgba(139, 92, 246, 0.15));
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: var(--primary);
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            animation: aiPulse 3s ease-in-out infinite;
            backdrop-filter: blur(4px);
        }

        .ai-badge::before {
            content: '‚ú®';
            font-size: 0.8rem;
            animation: aiSparkle 2s ease-in-out infinite;
        }

        @keyframes aiPulse {
            0%, 100% {
                box-shadow: 0 0 10px rgba(0, 212, 255, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1);
                border-color: rgba(0, 212, 255, 0.3);
            }
            50% {
                box-shadow: 0 0 15px rgba(0, 212, 255, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.1);
                border-color: rgba(0, 212, 255, 0.5);
            }
        }

        @keyframes aiSparkle {
            0%, 100% {
                opacity: 0.6;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.2);
            }
        }

        .narrative-dm.ai-response {
            border-left-color: var(--primary);
        }

        .action-bar {
            background: linear-gradient(135deg, var(--bg-medium), var(--bg-light));
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 1.75rem;
            box-shadow: var(--shadow-md);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .dice-roller {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .dice-btn {
            padding: 0.65rem 1.25rem;
            background: linear-gradient(135deg, var(--bg-dark), var(--bg-medium));
            border: 1px solid var(--border-light);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-family: 'Orbitron', sans-serif;
        }

        .dice-btn:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-glow);
            transform: translateY(-2px);
            background: linear-gradient(135deg, var(--primary-darker), var(--primary-dark));
        }

        /* Character List */
        .character-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        .character-card {
            background: linear-gradient(135deg, var(--bg-medium), var(--bg-light));
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 1.75rem;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        .character-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            opacity: 0.6;
        }

        .character-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-lg), var(--shadow-glow);
            border-color: var(--primary);
        }

        .character-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .character-name {
            font-size: 1.4rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--text-cyan), var(--text-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .character-level {
            color: var(--secondary);
            font-weight: 600;
        }

        .character-class-race {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .mb-1 { margin-bottom: 1rem; }
        .mb-2 { margin-bottom: 2rem; }
        .mt-1 { margin-top: 1rem; }
        .mt-2 { margin-top: 2rem; }
        .flex { display: flex; }
        .flex-gap { gap: 1rem; }
        .flex-between { justify-content: space-between; }
        .flex-center { justify-content: center; align-items: center; }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary-dark), var(--secondary-dark));
            border-radius: 10px;
            border: 2px solid var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--primary), var(--secondary));
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .game-layout {
                grid-template-columns: 1fr;
            }

            .character-panel {
                position: static;
            }

            h1 {
                font-size: 2rem;
            }

            .menu-card-icon {
                font-size: 2.5rem;
            }

            .stat-value {
                font-size: 2rem;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.5rem;
                letter-spacing: 1px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="loginScreen" class="screen active">
            <header>
                <h1>‚öîÔ∏è Solo Dungeon Master ‚öîÔ∏è</h1>
                <p class="subtitle">Advanced Dungeons & Dragons 1st Edition</p>
            </header>

            <div class="login-container">
                <div class="card">
                    <h2 class="card-title">Enter the Realm</h2>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="loginUsername" placeholder="Enter your username">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter your password">
                    </div>
                    <div class="flex flex-gap">
                        <button class="btn" onclick="login()">Login</button>
                        <button class="btn btn-secondary" onclick="showRegister()">Register</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Register Screen -->
        <div id="registerScreen" class="screen">
            <header>
                <h1>‚öîÔ∏è Solo Dungeon Master ‚öîÔ∏è</h1>
                <p class="subtitle">Create Your Account</p>
            </header>

            <div class="login-container">
                <div class="card">
                    <h2 class="card-title">Register New Adventurer</h2>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="registerUsername" placeholder="Choose a username">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="registerPassword" placeholder="Choose a password">
                    </div>
                    <div class="form-group">
                        <label>Confirm Password</label>
                        <input type="password" id="registerPasswordConfirm" placeholder="Confirm your password">
                    </div>
                    <div class="flex flex-gap">
                        <button class="btn" onclick="register()">Register</button>
                        <button class="btn btn-secondary" onclick="showLogin()">Back to Login</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Menu Screen -->
        <div id="mainMenuScreen" class="screen">
            <header>
                <h1>‚öîÔ∏è Solo Dungeon Master ‚öîÔ∏è</h1>
                <p class="subtitle">Welcome, <span id="welcomeUser"></span>!</p>
            </header>

            <div class="menu-grid">
                <div class="menu-card" onclick="showCharacterSelect()">
                    <div class="menu-card-icon">üé≠</div>
                    <div class="menu-card-title">Play Adventure</div>
                    <div class="menu-card-desc">Continue your epic journey</div>
                </div>

                <div class="menu-card" onclick="showCharacterCreation()">
                    <div class="menu-card-icon">‚ú®</div>
                    <div class="menu-card-title">Create Character</div>
                    <div class="menu-card-desc">Roll a new hero</div>
                </div>

                <div class="menu-card" onclick="showCharacterManagement()">
                    <div class="menu-card-icon">üìú</div>
                    <div class="menu-card-title">Manage Characters</div>
                    <div class="menu-card-desc">View and edit your characters</div>
                </div>

                <div class="menu-card" onclick="showSettings()">
                    <div class="menu-card-icon">‚öôÔ∏è</div>
                    <div class="menu-card-title">Settings</div>
                    <div class="menu-card-desc">Customize your experience</div>
                </div>

                <div class="menu-card" onclick="logout()">
                    <div class="menu-card-icon">üö™</div>
                    <div class="menu-card-title">Logout</div>
                    <div class="menu-card-desc">Exit the realm</div>
                </div>
            </div>
        </div>

        <!-- Character Creation Screen -->
        <div id="characterCreationScreen" class="screen">
            <header>
                <h1>Create Your Character</h1>
                <p class="subtitle">1st Edition Advanced Dungeons & Dragons</p>
            </header>

            <div class="card">
                <h2 class="card-title">Ability Scores</h2>
                <button class="btn mb-2" onclick="rollAbilityScores()">üé≤ Roll Ability Scores (3d6)</button>
                <div class="stats-grid" id="abilityScores"></div>
            </div>

            <div class="card">
                <h2 class="card-title">Character Details</h2>
                <div class="form-group">
                    <label>Character Name</label>
                    <input type="text" id="characterName" placeholder="Enter character name">
                </div>

                <div class="form-group">
                    <label>Race</label>
                    <select id="characterRace" onchange="updateClassOptions()">
                        <option value="">Select Race</option>
                        <option value="Human">Human</option>
                        <option value="Elf">Elf</option>
                        <option value="Dwarf">Dwarf</option>
                        <option value="Halfling">Halfling</option>
                        <option value="Half-Elf">Half-Elf</option>
                        <option value="Half-Orc">Half-Orc</option>
                        <option value="Gnome">Gnome</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Class</label>
                    <select id="characterClass">
                        <option value="">Select Class</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Alignment</label>
                    <select id="characterAlignment">
                        <option value="">Select Alignment</option>
                        <option value="Lawful Good">Lawful Good</option>
                        <option value="Neutral Good">Neutral Good</option>
                        <option value="Chaotic Good">Chaotic Good</option>
                        <option value="Lawful Neutral">Lawful Neutral</option>
                        <option value="True Neutral">True Neutral</option>
                        <option value="Chaotic Neutral">Chaotic Neutral</option>
                        <option value="Lawful Evil">Lawful Evil</option>
                        <option value="Neutral Evil">Neutral Evil</option>
                        <option value="Chaotic Evil">Chaotic Evil</option>
                    </select>
                </div>
            </div>

            <div class="flex flex-gap flex-center">
                <button class="btn btn-success" onclick="saveCharacter()">Create Character</button>
                <button class="btn btn-secondary" onclick="showMainMenu()">Cancel</button>
            </div>
        </div>

        <!-- Character Management Screen -->
        <div id="characterManagementScreen" class="screen">
            <header>
                <h1>Your Characters</h1>
                <p class="subtitle">Manage your adventurers</p>
            </header>

            <div class="character-list" id="characterList"></div>

            <div class="text-center mt-2">
                <button class="btn btn-secondary" onclick="showMainMenu()">Back to Menu</button>
            </div>
        </div>

        <!-- Character Select Screen -->
        <div id="characterSelectScreen" class="screen">
            <header>
                <h1>Select Your Character</h1>
                <p class="subtitle">Choose your adventurer</p>
            </header>

            <div class="character-list" id="characterSelectList"></div>

            <div class="text-center mt-2">
                <button class="btn btn-secondary" onclick="showMainMenu()">Back to Menu</button>
            </div>
        </div>

        <!-- Game Session Screen -->
        <div id="gameSessionScreen" class="screen">
            <header>
                <div class="flex flex-between" style="align-items: center;">
                    <div>
                        <h1>Adventure in Progress</h1>
                        <p class="subtitle">World of Greyhawk</p>
                    </div>
                    <button class="btn btn-danger" onclick="endSession()">End Session</button>
                </div>
            </header>

            <div class="game-layout">
                <div class="character-panel">
                    <h3 class="card-title">Character</h3>
                    <div id="activeCharacterDisplay"></div>
                </div>

                <div class="game-area">
                    <div class="narrative-box" id="narrativeBox"></div>

                    <div class="action-bar">
                        <div class="form-group">
                            <label>What do you do?</label>
                            <textarea id="playerAction" rows="3" placeholder="Describe your action..."></textarea>
                        </div>
                        <button class="btn btn-success" onclick="submitAction()">Submit Action</button>

                        <div class="dice-roller">
                            <strong style="color: var(--secondary);">Quick Rolls:</strong>
                            <button class="dice-btn" onclick="rollDice(4)">d4</button>
                            <button class="dice-btn" onclick="rollDice(6)">d6</button>
                            <button class="dice-btn" onclick="rollDice(8)">d8</button>
                            <button class="dice-btn" onclick="rollDice(10)">d10</button>
                            <button class="dice-btn" onclick="rollDice(12)">d12</button>
                            <button class="dice-btn" onclick="rollDice(20)">d20</button>
                            <button class="dice-btn" onclick="rollDice(100)">d100</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Screen -->
        <div id="settingsScreen" class="screen">
            <header>
                <h1>Settings</h1>
                <p class="subtitle">Customize Your Experience</p>
            </header>

            <div class="card">
                <h2 class="card-title">Game Settings</h2>

                <div class="form-group">
                    <label>DM Style</label>
                    <select id="dmStyle">
                        <option value="descriptive">Descriptive & Immersive</option>
                        <option value="balanced">Balanced</option>
                        <option value="concise">Concise & Fast-Paced</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Difficulty</label>
                    <select id="difficulty">
                        <option value="easy">Easy</option>
                        <option value="normal" selected>Normal</option>
                        <option value="hard">Hard</option>
                        <option value="deadly">Deadly</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Campaign Setting</label>
                    <select id="setting">
                        <option value="greyhawk" selected>World of Greyhawk</option>
                        <option value="forgotten-realms">Forgotten Realms</option>
                        <option value="dragonlance">Dragonlance</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">üíæ Data Management</h2>
                <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                    Your data is stored locally in your browser. Export to backup or transfer to another device.
                </p>

                <div class="flex flex-gap" style="margin-bottom: 1rem;">
                    <button class="btn" onclick="exportData()">üì• Export Data</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">üì§ Import Data</button>
                    <input type="file" id="importFile" style="display: none;" accept=".json" onchange="importData(event)">
                </div>

                <p style="color: var(--secondary); font-size: 0.85rem;">
                    Export creates a backup file. Import restores from a backup (will merge with existing data).
                </p>
            </div>

            <div class="card">
                <h2 class="card-title">ü§ñ AI Dungeon Master</h2>
                <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                    Enable Claude AI for truly dynamic, contextual DM responses instead of procedural generation.
                </p>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="useAI" style="width: auto; margin: 0;">
                        Use AI Dungeon Master
                    </label>
                    <p style="color: var(--secondary); font-size: 0.85rem; margin-top: 0.5rem;">
                        <span id="aiStatus"></span>
                    </p>
                </div>

                <div class="form-group">
                    <label>AI Model</label>
                    <select id="aiModel">
                        <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet (Recommended)</option>
                        <option value="claude-3-5-haiku-20241022">Claude 3.5 Haiku (Faster, Cheaper)</option>
                        <option value="claude-3-opus-20240229">Claude 3 Opus (Most Creative)</option>
                    </select>
                </div>

                <details style="margin-top: 1rem;" id="adminSection">
                    <summary style="cursor: pointer; color: var(--text-gold); font-weight: 600;" onclick="checkAdminAccess(event)">üîë Admin: Global Settings & Cloud Sync</summary>
                    <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-dark); border-radius: 6px;" id="adminContent">
                        <h3 style="color: var(--text-cyan); margin-bottom: 0.5rem;">ü§ñ Global AI Configuration</h3>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            Admins can set a global API key that ALL users can use. This allows everyone to enjoy AI responses without needing their own key.
                        </p>
                        <div class="form-group">
                            <label>Global Anthropic API Key</label>
                            <input type="password" id="adminApiKey" placeholder="sk-ant-api03-...">
                            <p style="color: var(--secondary); font-size: 0.8rem; margin-top: 0.5rem;">
                                Get your API key from <a href="https://console.anthropic.com/" target="_blank" style="color: var(--text-cyan);">console.anthropic.com</a>
                            </p>
                        </div>
                        <button class="btn" onclick="saveAdminApiKey()">Save Global API Key</button>
                        <p style="color: var(--accent); font-size: 0.85rem; margin-top: 1rem;">
                            ‚ö†Ô∏è This key will be used by all users. API costs will be charged to this account.
                        </p>

                        <hr style="margin: 1.5rem 0; border-color: var(--border-dark);">

                        <h3 style="color: var(--text-cyan); margin-bottom: 0.5rem;">‚òÅÔ∏è Global Cloud Sync</h3>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            Configure cloud sync for ALL users. When enabled, all user data automatically syncs to GitHub Gist after sessions. Users don't need to configure anything!
                        </p>

                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="adminEnableCloudSync" style="width: auto; margin: 0;">
                                Enable Automatic Cloud Sync for All Users
                            </label>
                        </div>

                        <div class="form-group">
                            <label>GitHub Personal Access Token</label>
                            <input type="password" id="adminGithubToken" placeholder="ghp_...">
                            <p style="color: var(--secondary); font-size: 0.8rem; margin-top: 0.5rem;">
                                Create a token at <a href="https://github.com/settings/tokens/new?description=Solo%20DM&scopes=gist" target="_blank" style="color: var(--text-cyan);">github.com/settings/tokens</a> with "gist" scope
                            </p>
                        </div>

                        <div class="form-group">
                            <label>Gist ID (auto-filled after first sync)</label>
                            <input type="text" id="adminGistId" placeholder="Auto-generated on first sync" readonly>
                        </div>

                        <button class="btn" onclick="saveAdminCloudSettings()">Save Cloud Sync Settings</button>

                        <div class="flex flex-gap" style="margin-top: 1rem;">
                            <button class="btn btn-secondary" onclick="adminSyncNow()">‚òÅÔ∏è Sync All Users Now</button>
                            <button class="btn btn-secondary" onclick="adminLoadFromCloud()">‚¨áÔ∏è Load from Cloud</button>
                        </div>

                        <p style="color: var(--accent); font-size: 0.85rem; margin-top: 1rem;">
                            ‚ö†Ô∏è All user data will be automatically synced to your GitHub account. Keep your token secure!
                        </p>

                        <hr style="margin: 1.5rem 0; border-color: var(--border-dark);">
                        <button class="btn btn-secondary" onclick="changeAdminPassword()">Change Admin Password</button>
                    </div>
                </details>
            </div>

            <div class="flex flex-gap flex-center">
                <button class="btn btn-success" onclick="saveSettings()">Save Settings</button>
                <button class="btn btn-secondary" onclick="showMainMenu()">Back to Menu</button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // DATA STRUCTURES & STATE
        // ========================================

        let currentUser = null;
        let currentCharacter = null;
        let gameSession = null;

        const AD_AND_D_DATA = {
            classes: {
                Human: ['Fighter', 'Ranger', 'Paladin', 'Cleric', 'Druid', 'Magic-User', 'Illusionist', 'Thief', 'Assassin', 'Monk'],
                Elf: ['Fighter', 'Magic-User', 'Thief', 'Fighter/Magic-User', 'Fighter/Thief', 'Magic-User/Thief'],
                Dwarf: ['Fighter', 'Thief', 'Fighter/Thief'],
                Halfling: ['Fighter', 'Thief', 'Fighter/Thief'],
                'Half-Elf': ['Cleric', 'Druid', 'Fighter', 'Ranger', 'Magic-User', 'Thief', 'Cleric/Fighter', 'Cleric/Ranger', 'Fighter/Magic-User', 'Fighter/Thief', 'Magic-User/Thief'],
                'Half-Orc': ['Cleric', 'Fighter', 'Thief', 'Assassin', 'Cleric/Fighter', 'Cleric/Thief', 'Fighter/Thief'],
                Gnome: ['Fighter', 'Illusionist', 'Thief', 'Assassin', 'Fighter/Illusionist', 'Fighter/Thief', 'Illusionist/Thief']
            },

            hitDice: {
                'Fighter': 10, 'Ranger': 8, 'Paladin': 10,
                'Cleric': 8, 'Druid': 8,
                'Magic-User': 4, 'Illusionist': 4,
                'Thief': 6, 'Assassin': 6,
                'Monk': 4
            }
        };

        // World of Greyhawk locations
        const GREYHAWK_LOCATIONS = [
            'City of Greyhawk', 'Dyvers', 'Verbobonc', 'Highport', 'Nulb',
            'Temple of Elemental Evil', 'Ruins of Castle Greyhawk', 'Village of Hommlet',
            'Wild Coast', 'Gnarley Forest', 'Cairn Hills', 'Abbor-Alz'
        ];

        // Enhanced DM Content Database
        const DM_CONTENT = {
            locations: {
                tavern: ['The Prancing Pony', 'The Green Dragon', 'The Slumbering Drake', 'The Golden Griffin', 'The Rusty Nail', 'The Silver Stag'],
                dungeon: ['Crypts of Zagyg', 'The Howling Caves', 'Blackstone Prison', 'The Sunless Citadel', 'Tomb of Horrors', 'The Moathouse Ruins'],
                wilderness: ['Gnarley Forest', 'Dim Forest', 'Kron Hills', 'Abbor-Alz', 'Bright Desert', 'Vesve Forest'],
                ruins: ['Temple of Elemental Evil', 'Castle Greyhawk', 'The Lost Temple', 'Maure Castle', 'Tower of Zagig']
            },

            npcNames: {
                male: ['Elric', 'Gareth', 'Thorne', 'Aldric', 'Brom', 'Cedric', 'Dain', 'Erik', 'Finn', 'Godfrey', 'Haldor', 'Ivan', 'Joran', 'Kellan', 'Lars'],
                female: ['Aria', 'Brenna', 'Celeste', 'Diana', 'Elena', 'Freya', 'Giselle', 'Helga', 'Isolde', 'Janine', 'Kiera', 'Lyra', 'Mira', 'Nessa'],
                fantasy: ['Xandros', 'Zephyr', 'Mordecai', 'Thaddeus', 'Oberon', 'Ragnar', 'Soren', 'Valtor', 'Wyrmwood', 'Zoltan']
            },

            npcPersonalities: [
                { trait: 'nervous and twitchy', speech: 'speaks quickly and glances around constantly' },
                { trait: 'gruff but kind-hearted', speech: 'speaks in short, clipped sentences but smiles warmly' },
                { trait: 'mysterious and cryptic', speech: 'chooses words carefully, often speaking in riddles' },
                { trait: 'jovial and loud', speech: 'laughs heartily and slaps backs' },
                { trait: 'scholarly and precise', speech: 'uses elaborate vocabulary and corrects others' },
                { trait: 'suspicious and paranoid', speech: 'whispers and looks over their shoulder' },
                { trait: 'aggressive and confrontational', speech: 'speaks with barely contained anger' },
                { trait: 'charming and persuasive', speech: 'uses honeyed words and flattery' },
                { trait: 'world-weary and cynical', speech: 'sighs often and expects the worst' },
                { trait: 'enthusiastic and naive', speech: 'speaks with wide-eyed wonder' }
            ],

            questTypes: [
                { type: 'rescue', objective: 'rescue someone from danger', reward: 'gratitude and gold' },
                { type: 'retrieve', objective: 'recover a lost or stolen item', reward: 'a finder\'s fee or the item itself' },
                { type: 'eliminate', objective: 'defeat a threatening creature or villain', reward: 'bounty and local fame' },
                { type: 'escort', objective: 'safely escort someone to their destination', reward: 'payment and information' },
                { type: 'investigate', objective: 'uncover the truth behind mysterious events', reward: 'knowledge and allies' },
                { type: 'explore', objective: 'map or explore a dangerous location', reward: 'whatever treasures you find' },
                { type: 'defend', objective: 'protect a location from attack', reward: 'the gratitude of those saved' },
                { type: 'deliver', objective: 'deliver an important message or package', reward: 'payment and potential secrets' }
            ],

            enemies: [
                { name: 'Orc Raider', description: 'scarred and battle-hardened', threat: 'medium', tactics: 'charges recklessly with a battle cry' },
                { name: 'Goblin Ambusher', description: 'small but cunning', threat: 'low', tactics: 'strikes from shadows then retreats' },
                { name: 'Skeletal Warrior', description: 'ancient and relentless', threat: 'medium', tactics: 'advances slowly, immune to fear' },
                { name: 'Bandit Captain', description: 'well-armed and confident', threat: 'high', tactics: 'fights strategically, calling for backup' },
                { name: 'Giant Spider', description: 'the size of a horse', threat: 'high', tactics: 'attempts to web you before striking' },
                { name: 'Zombie', description: 'rotting and mindless', threat: 'low', tactics: 'shambles forward, ignoring pain' },
                { name: 'Hobgoblin Sergeant', description: 'disciplined and armored', threat: 'high', tactics: 'fights with military precision' },
                { name: 'Shadow', description: 'incorporeal and chilling', threat: 'very high', tactics: 'drains your strength with its touch' },
                { name: 'Gnoll Scavenger', description: 'hyena-like and savage', threat: 'medium', tactics: 'fights in a pack, targeting the weak' },
                { name: 'Cultist', description: 'fanatical and wild-eyed', threat: 'medium', tactics: 'chants dark prayers while attacking' }
            ],

            treasures: [
                'a leather pouch containing ancient gold coins worth 3d6√ó10 gp',
                'a silver ring engraved with arcane symbols (possibly magical)',
                'a well-crafted longsword with a griffin emblem on the pommel',
                'a scroll case containing a map to a nearby dungeon',
                'a potion in a crystal vial that glows faintly blue',
                'a small gemstone that catches the light beautifully (worth 50-200 gp)',
                'an old journal written in a strange language',
                'a masterwork dagger with a bone handle',
                'a holy symbol made of pure silver',
                'a set of fine lockpicks wrapped in black leather',
                'an ornate amulet depicting a dragon',
                'a weathered spellbook with several pages torn out',
                'a compass that always points toward the nearest temple',
                'a cloak that seems to shimmer in the moonlight'
            ],

            environmentDetails: {
                dungeon: [
                    'The walls are slick with moisture and covered in phosphorescent moss',
                    'Ancient murals depict battles between gods and demons',
                    'The air smells of decay and forgotten centuries',
                    'Chains hang from the ceiling, swaying slightly despite the still air',
                    'Strange symbols glow faintly in the darkness',
                    'The floor is littered with the bones of previous explorers',
                    'Water drips steadily, echoing through empty corridors',
                    'Scratches mar the stonework, as if something clawed at the walls'
                ],
                wilderness: [
                    'The forest is unnaturally quiet - even the birds have ceased their songs',
                    'Mist clings to the ground, obscuring your feet as you walk',
                    'Ancient trees tower overhead, their branches forming a dense canopy',
                    'The path ahead is overgrown and barely visible',
                    'Strange fungi grow in vibrant colors along the tree trunks',
                    'You hear the distant howl of wolves',
                    'The undergrowth rustles with unseen movement',
                    'A stream babbles nearby, its water crystal clear'
                ],
                town: [
                    'The streets are busy with merchants hawking their wares',
                    'Guards patrol in pairs, eyeing strangers suspiciously',
                    'The smell of fresh bread wafts from a nearby bakery',
                    'Children play in the streets, chasing a stray dog',
                    'Town criers announce the latest news and proclamations',
                    'The marketplace bustles with activity and haggling',
                    'A gallows stands in the town square, a grim reminder',
                    'Beggars line the alleyways, watching passersby hopefully'
                ]
            },

            complications: [
                'but you notice something suspicious about the situation',
                'however, you\'re not the only one interested in this',
                'though time is clearly of the essence',
                'but there may be more to this than meets the eye',
                'yet something feels wrong about all of this',
                'although you sense hidden dangers ahead',
                'but the cost of failure would be dire',
                'however, trust may be in short supply here'
            ]
        };

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function saveToStorage(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        function loadFromStorage(key) {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : null;
        }

        function rollDie(sides) {
            return Math.floor(Math.random() * sides) + 1;
        }

        function rollDice(sides, count = 1) {
            let total = 0;
            let rolls = [];
            for (let i = 0; i < count; i++) {
                const roll = rollDie(sides);
                rolls.push(roll);
                total += roll;
            }

            if (gameSession) {
                addNarrative(`üé≤ Rolled ${count}d${sides}: [${rolls.join(', ')}] = ${total}`, 'system');
            }

            return { total, rolls };
        }

        function getAbilityModifier(score) {
            if (score <= 3) return -3;
            if (score <= 5) return -2;
            if (score <= 8) return -1;
            if (score <= 12) return 0;
            if (score <= 15) return 1;
            if (score <= 17) return 2;
            return 3;
        }

        // ========================================
        // AUTHENTICATION
        // ========================================

        function showLogin() {
            showScreen('loginScreen');
        }

        function showRegister() {
            showScreen('registerScreen');
        }

        function register() {
            const username = document.getElementById('registerUsername').value.trim().toLowerCase();
            const password = document.getElementById('registerPassword').value;
            const confirm = document.getElementById('registerPasswordConfirm').value;

            if (!username || !password) {
                alert('Please fill in all fields');
                return;
            }

            if (password !== confirm) {
                alert('Passwords do not match');
                return;
            }

            const users = loadFromStorage('users') || {};

            if (users[username]) {
                alert('Username already exists');
                return;
            }

            users[username] = {
                password: password, // In production, this should be hashed
                characters: [],
                settings: {
                    dmStyle: 'descriptive',
                    difficulty: 'normal',
                    setting: 'greyhawk'
                },
                campaigns: []
            };

            saveToStorage('users', users);

            // Auto-sync new user to cloud
            autoSyncIfEnabled();

            alert('Registration successful! Please login.');
            showLogin();
        }

        async function login() {
            const username = document.getElementById('loginUsername').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value;

            if (!username || !password) {
                alert('Please fill in all fields');
                return;
            }

            // Try to load from cloud first (if configured)
            const cloudSyncEnabled = loadFromStorage('adminCloudSyncEnabled');
            const githubToken = loadFromStorage('adminGithubToken');
            const gistId = loadFromStorage('adminGistId');

            if (cloudSyncEnabled && githubToken && gistId) {
                try {
                    console.log('[Login] Loading latest data from cloud...');
                    await adminLoadFromCloudSilent();
                } catch (error) {
                    console.warn('[Login] Could not load from cloud:', error);
                    // Continue with local data
                }
            }

            const users = loadFromStorage('users') || {};

            if (!users[username] || users[username].password !== password) {
                alert('Invalid username or password');
                return;
            }

            currentUser = username;
            saveToStorage('currentUser', username);

            console.log('[Login] Successful! User:', username);
            showMainMenu();
        }

        function logout() {
            // Auto-sync before logout to save any changes
            autoSyncIfEnabled();

            currentUser = null;
            currentCharacter = null;
            gameSession = null;
            localStorage.removeItem('currentUser');
            showLogin();
        }

        function showMainMenu() {
            document.getElementById('welcomeUser').textContent = currentUser;

            // Load AI settings for current user
            const users = loadFromStorage('users');
            const settings = users[currentUser].settings;
            AI_CONFIG.useAI = settings.useAI || false;
            AI_CONFIG.apiKey = getEffectiveApiKey(); // Use global or user key
            AI_CONFIG.model = settings.aiModel || 'claude-3-5-sonnet-20241022';

            console.log('[Settings] AI Config loaded:', {
                useAI: AI_CONFIG.useAI,
                hasApiKey: !!AI_CONFIG.apiKey,
                model: AI_CONFIG.model
            });

            showScreen('mainMenuScreen');
        }

        // ========================================
        // CHARACTER CREATION
        // ========================================

        function showCharacterCreation() {
            showScreen('characterCreationScreen');
            document.getElementById('abilityScores').innerHTML = '<p style="color: var(--text-secondary);">Click "Roll Ability Scores" to begin</p>';
            document.getElementById('characterName').value = '';
            document.getElementById('characterRace').value = '';
            document.getElementById('characterClass').value = '';
            document.getElementById('characterAlignment').value = '';
        }

        function rollAbilityScores() {
            const abilities = ['Strength', 'Intelligence', 'Wisdom', 'Dexterity', 'Constitution', 'Charisma'];
            const scores = {};

            let html = '';
            abilities.forEach(ability => {
                const roll = rollDice(6, 3);
                scores[ability] = roll.total;
                const modifier = getAbilityModifier(roll.total);
                const modifierText = modifier >= 0 ? `+${modifier}` : modifier;

                html += `
                    <div class="stat-box">
                        <div class="stat-label">${ability}</div>
                        <div class="stat-value">${roll.total}</div>
                        <div class="stat-modifier">${modifierText}</div>
                    </div>
                `;
            });

            document.getElementById('abilityScores').innerHTML = html;
            document.getElementById('abilityScores').dataset.scores = JSON.stringify(scores);
        }

        function updateClassOptions() {
            const race = document.getElementById('characterRace').value;
            const classSelect = document.getElementById('characterClass');

            classSelect.innerHTML = '<option value="">Select Class</option>';

            if (race && AD_AND_D_DATA.classes[race]) {
                AD_AND_D_DATA.classes[race].forEach(className => {
                    classSelect.innerHTML += `<option value="${className}">${className}</option>`;
                });
            }
        }

        function saveCharacter() {
            const name = document.getElementById('characterName').value.trim();
            const race = document.getElementById('characterRace').value;
            const charClass = document.getElementById('characterClass').value;
            const alignment = document.getElementById('characterAlignment').value;
            const scoresData = document.getElementById('abilityScores').dataset.scores;

            if (!name || !race || !charClass || !alignment || !scoresData) {
                alert('Please complete all fields and roll ability scores');
                return;
            }

            const scores = JSON.parse(scoresData);

            // Calculate HP
            const baseClass = charClass.split('/')[0]; // For multi-class, use first class
            const hitDie = AD_AND_D_DATA.hitDice[baseClass] || 6;
            const conMod = getAbilityModifier(scores.Constitution);
            const hp = Math.max(1, hitDie + conMod);

            const character = {
                id: Date.now().toString(),
                name,
                race,
                class: charClass,
                alignment,
                level: 1,
                xp: 0,
                hp: hp,
                maxHp: hp,
                abilities: scores,
                equipment: ['Backpack', 'Waterskin', 'Rations (7 days)', 'Bedroll', 'Torches (10)'],
                gold: rollDice(6, 3).total * 10,
                spells: [],
                createdAt: new Date().toISOString()
            };

            const users = loadFromStorage('users');
            users[currentUser].characters.push(character);
            saveToStorage('users', users);

            alert(`${name} the ${race} ${charClass} has been created!`);
            showMainMenu();
        }

        // ========================================
        // CHARACTER MANAGEMENT
        // ========================================

        function showCharacterManagement() {
            showScreen('characterManagementScreen');
            renderCharacterList('characterList', true);
        }

        function showCharacterSelect() {
            const users = loadFromStorage('users');
            const characters = users[currentUser].characters;

            if (characters.length === 0) {
                alert('You have no characters. Create one first!');
                showCharacterCreation();
                return;
            }

            showScreen('characterSelectScreen');
            renderCharacterList('characterSelectList', false);
        }

        function renderCharacterList(containerId, showDelete) {
            const users = loadFromStorage('users');
            const characters = users[currentUser].characters;
            const container = document.getElementById(containerId);

            if (characters.length === 0) {
                container.innerHTML = '<div class="card"><p class="text-center">No characters yet. Create your first adventurer!</p></div>';
                return;
            }

            container.innerHTML = characters.map(char => `
                <div class="character-card" onclick="${showDelete ? '' : `startSession('${char.id}')`}">
                    <div class="character-header">
                        <div>
                            <div class="character-name">${char.name}</div>
                            <div class="character-level">Level ${char.level}</div>
                        </div>
                        ${showDelete ? `<button class="btn btn-danger" onclick="event.stopPropagation(); deleteCharacter('${char.id}')">Delete</button>` : ''}
                    </div>
                    <div class="character-class-race">${char.race} ${char.class}</div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">
                        HP: ${char.hp}/${char.maxHp} | XP: ${char.xp} | Gold: ${char.gold} gp
                    </div>
                </div>
            `).join('');
        }

        function deleteCharacter(charId) {
            if (!confirm('Are you sure you want to delete this character? This cannot be undone!')) {
                return;
            }

            const users = loadFromStorage('users');
            users[currentUser].characters = users[currentUser].characters.filter(c => c.id !== charId);
            saveToStorage('users', users);
            renderCharacterList('characterList', true);
        }

        // ========================================
        // GAME SESSION
        // ========================================

        function startSession(charId) {
            const users = loadFromStorage('users');
            currentCharacter = users[currentUser].characters.find(c => c.id === charId);

            if (!currentCharacter) {
                alert('Character not found');
                return;
            }

            // Initialize or load game session
            const existingSession = users[currentUser].campaigns.find(c => c.characterId === charId);

            if (existingSession) {
                gameSession = existingSession;
            } else {
                gameSession = {
                    characterId: charId,
                    location: GREYHAWK_LOCATIONS[0],
                    narrative: [],
                    questLog: [],
                    encounterCount: 0,
                    startedAt: new Date().toISOString()
                };

                // Opening narration
                const openingNarrative = generateOpeningNarrative();
                gameSession.narrative.push({
                    type: 'dm',
                    text: openingNarrative,
                    timestamp: new Date().toISOString()
                });

                users[currentUser].campaigns.push(gameSession);
                saveToStorage('users', users);
            }

            showScreen('gameSessionScreen');
            renderCharacterPanel();
            renderNarrative();
        }

        function generateOpeningNarrative() {
            const setting = loadFromStorage('users')[currentUser].settings.setting;

            const openings = [
                `Your journey begins in the bustling ${gameSession.location}. The air is thick with the scent of adventure, and danger lurks around every corner. As ${currentCharacter.name}, you stand at the threshold of greatness. The autumn sun casts long shadows across the cobblestone streets, and you feel the weight of destiny upon your shoulders.`,

                `The road has been long and arduous, but finally you arrive at ${gameSession.location}. As a ${currentCharacter.race} ${currentCharacter.class}, you've heard tales of fortune and glory in these lands. The city gates stand before you, guarded by watchful sentries. What brings you to this place, ${currentCharacter.name}?`,

                `${currentCharacter.name}, your reputation as a ${currentCharacter.class} precedes you. You find yourself in ${gameSession.location}, a place where heroes are forged and legends are born. The streets are alive with activity - merchants hawking their wares, guards making their rounds, and shadowy figures lurking in alleyways. Your adventure is about to begin.`
            ];

            return openings[Math.floor(Math.random() * openings.length)];
        }

        function renderCharacterPanel() {
            const html = `
                <div style="margin-bottom: 1rem;">
                    <h3 style="color: var(--text-cyan); margin-bottom: 0.5rem;">${currentCharacter.name}</h3>
                    <p style="color: var(--text-secondary); font-size: 0.9rem;">${currentCharacter.race} ${currentCharacter.class}</p>
                    <p style="color: var(--secondary); font-size: 0.9rem;">Level ${currentCharacter.level}</p>
                </div>

                <div style="margin-bottom: 1rem; padding: 0.5rem; background: var(--bg-dark); border-radius: 4px;">
                    <strong style="color: var(--secondary);">HP:</strong> ${currentCharacter.hp}/${currentCharacter.maxHp}<br>
                    <strong style="color: var(--secondary);">XP:</strong> ${currentCharacter.xp}<br>
                    <strong style="color: var(--secondary);">Gold:</strong> ${currentCharacter.gold} gp
                </div>

                <div style="margin-bottom: 1rem;">
                    <strong style="color: var(--secondary); display: block; margin-bottom: 0.5rem;">Abilities:</strong>
                    ${Object.entries(currentCharacter.abilities).map(([ability, score]) => {
                        const mod = getAbilityModifier(score);
                        return `<div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                            <span>${ability.substring(0, 3).toUpperCase()}:</span>
                            <span>${score} (${mod >= 0 ? '+' : ''}${mod})</span>
                        </div>`;
                    }).join('')}
                </div>

                <div>
                    <strong style="color: var(--secondary); display: block; margin-bottom: 0.5rem;">Equipment:</strong>
                    <div style="font-size: 0.9rem; color: var(--text-light);">
                        ${currentCharacter.equipment.slice(0, 5).join(', ')}${currentCharacter.equipment.length > 5 ? '...' : ''}
                    </div>
                </div>
            `;

            document.getElementById('activeCharacterDisplay').innerHTML = html;
        }

        function renderNarrative() {
            const narrativeBox = document.getElementById('narrativeBox');

            narrativeBox.innerHTML = gameSession.narrative.map(entry => {
                const typeClass = entry.type === 'dm' ? 'narrative-dm' :
                                 entry.type === 'player' ? 'narrative-player' :
                                 'narrative-system';
                const prefix = entry.type === 'dm' ? 'üìñ DM: ' :
                              entry.type === 'player' ? '‚öîÔ∏è You: ' :
                              'üé≤ ';

                // Add AI badge for AI-generated DM responses
                const aiBadge = (entry.type === 'dm' && entry.isAI) ? '<span class="ai-badge">AI</span>' : '';
                const aiClass = (entry.type === 'dm' && entry.isAI) ? 'ai-response' : '';

                return `
                    <div class="narrative-entry ${typeClass} ${aiClass}">
                        ${aiBadge}
                        <strong style="color: var(--secondary);">${prefix}</strong>
                        ${entry.text}
                    </div>
                `;
            }).join('');

            // Scroll to bottom
            narrativeBox.scrollTop = narrativeBox.scrollHeight;
        }

        function addNarrative(text, type = 'dm', isAI = false) {
            gameSession.narrative.push({
                type,
                text,
                timestamp: new Date().toISOString(),
                isAI: isAI // Track if response was generated by AI
            });

            // Save session
            const users = loadFromStorage('users');
            const campaignIndex = users[currentUser].campaigns.findIndex(c => c.characterId === currentCharacter.id);
            users[currentUser].campaigns[campaignIndex] = gameSession;
            saveToStorage('users', users);

            renderNarrative();
        }

        async function submitAction() {
            const actionInput = document.getElementById('playerAction');
            const action = actionInput.value.trim();

            if (!action) {
                alert('Please describe your action');
                return;
            }

            // Add player action to narrative
            addNarrative(action, 'player');
            actionInput.value = '';

            // Show thinking indicator
            addNarrative('The DM is considering your action...', 'system');

            // Generate DM response (handles both AI and procedural)
            setTimeout(async () => {
                try {
                    const responseObj = await generateDMResponse(action);

                    // Remove thinking indicator
                    gameSession.narrative = gameSession.narrative.filter(n =>
                        !n.text.includes('DM is considering')
                    );

                    // Add narrative with AI flag
                    addNarrative(responseObj.text, 'dm', responseObj.isAI);
                } catch (error) {
                    console.error('Error generating response:', error);
                    gameSession.narrative = gameSession.narrative.filter(n =>
                        !n.text.includes('DM is considering')
                    );
                    addNarrative('An error occurred. The DM will use traditional methods.', 'system');
                    const fallbackResponse = generateDMResponseProcedural(action);
                    addNarrative(fallbackResponse, 'dm', false);
                }
            }, 1000);
        }

        // ========================================
        // ENHANCED DM RESPONSE SYSTEM
        // ========================================

        function random(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        function generateNPC() {
            const gender = Math.random() > 0.5 ? 'male' : 'female';
            const nameType = Math.random() > 0.7 ? 'fantasy' : gender;
            const name = random(DM_CONTENT.npcNames[nameType]);
            const personality = random(DM_CONTENT.npcPersonalities);

            return {
                name,
                personality: personality.trait,
                speech: personality.speech,
                gender
            };
        }

        function getContextualEnvironment() {
            const recentActions = gameSession.narrative.slice(-5);
            const hasExploredDungeon = recentActions.some(n =>
                n.text.toLowerCase().includes('dungeon') ||
                n.text.toLowerCase().includes('crypt') ||
                n.text.toLowerCase().includes('cave')
            );
            const inTown = recentActions.some(n =>
                n.text.toLowerCase().includes('town') ||
                n.text.toLowerCase().includes('city') ||
                n.text.toLowerCase().includes('village')
            );

            if (hasExploredDungeon) return 'dungeon';
            if (inTown) return 'town';
            return 'wilderness';
        }

        // AI API Configuration
        const AI_CONFIG = {
            useAI: false, // Set to true to use AI API instead of procedural generation
            apiKey: '', // Populated from global or user settings
            model: 'claude-3-5-sonnet-20241022',
            apiEndpoint: 'https://api.anthropic.com/v1/messages'
        };

        // Get the effective API key (global or user-specific)
        function getEffectiveApiKey() {
            // Check for global admin key first
            const globalKey = loadFromStorage('globalApiKey');
            if (globalKey) return globalKey;

            // Fall back to user-specific key (legacy)
            if (currentUser) {
                const users = loadFromStorage('users');
                return users[currentUser]?.settings?.apiKey || '';
            }

            return '';
        }

        async function generateDMResponseWithAI(playerAction) {
            const users = loadFromStorage('users');
            const settings = users[currentUser].settings;

            // Build context for the AI
            const recentNarrative = gameSession.narrative.slice(-5).map(n =>
                `${n.type === 'player' ? 'Player' : 'DM'}: ${n.text}`
            ).join('\n');

            const systemPrompt = `You are an expert Dungeon Master for AD&D 1st Edition, running a solo adventure in the World of Greyhawk.

GAME STATE:
- Character: ${currentCharacter.name}, Level ${currentCharacter.level} ${currentCharacter.race} ${currentCharacter.class}
- Alignment: ${currentCharacter.alignment}
- Location: ${gameSession.location}
- Stats: STR ${currentCharacter.abilities.Strength}, INT ${currentCharacter.abilities.Intelligence}, WIS ${currentCharacter.abilities.Wisdom}, DEX ${currentCharacter.abilities.Dexterity}, CON ${currentCharacter.abilities.Constitution}, CHA ${currentCharacter.abilities.Charisma}
- HP: ${currentCharacter.hp}/${currentCharacter.maxHp}
- DM Style: ${settings.dmStyle}
- Difficulty: ${settings.difficulty}

RECENT NARRATIVE:
${recentNarrative}

INSTRUCTIONS:
- Respond to the player's action with vivid, immersive narration
- Use the character's stats to influence outcomes (high WIS notices more, high CHA influences NPCs, etc.)
- Follow AD&D 1st Edition rules
- Include dice rolls when appropriate (format: "Roll 1d20 + modifier")
- Create memorable NPCs with personalities
- Build on previous narrative events
- Keep responses concise but descriptive (2-4 paragraphs)
- Include consequences and choices`;

            try {
                console.log('[AI] Calling Claude API with model:', AI_CONFIG.model);

                const response = await fetch(AI_CONFIG.apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': AI_CONFIG.apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: AI_CONFIG.model,
                        max_tokens: 1024,
                        system: systemPrompt,
                        messages: [{
                            role: 'user',
                            content: `Player action: ${playerAction}\n\nRespond as the Dungeon Master.`
                        }]
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[AI] API Error:', response.status, errorText);
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                console.log('[AI] ‚úì Successfully generated AI response');
                return { text: data.content[0].text, isAI: true };

            } catch (error) {
                console.error('[AI] ‚úó AI generation failed, falling back to procedural:', error.message);
                // Fallback to procedural generation
                const proceduralResponse = generateDMResponseProcedural(playerAction);
                return { text: proceduralResponse, isAI: false };
            }
        }

        async function generateDMResponse(playerAction) {
            // Use AI or procedural generation based on config
            const effectiveApiKey = getEffectiveApiKey();

            console.log('[AI] Config check:', {
                useAI: AI_CONFIG.useAI,
                hasApiKey: !!effectiveApiKey,
                apiKeyPreview: effectiveApiKey ? effectiveApiKey.substring(0, 10) + '...' : 'none'
            });

            if (AI_CONFIG.useAI && effectiveApiKey) {
                AI_CONFIG.apiKey = effectiveApiKey; // Set for current call
                console.log('[AI] Using AI for DM response');
                return await generateDMResponseWithAI(playerAction);
            } else {
                console.log('[AI] Using procedural generation - AI disabled or no API key');
                const proceduralResponse = generateDMResponseProcedural(playerAction);
                return { text: proceduralResponse, isAI: false };
            }
        }

        function generateDMResponseProcedural(playerAction) {
            const users = loadFromStorage('users');
            const settings = users[currentUser].settings;
            const action = playerAction.toLowerCase();

            // Increment encounter count
            gameSession.encounterCount++;

            // Initialize session context if needed
            if (!gameSession.context) {
                gameSession.context = {
                    activeQuests: [],
                    knownNPCs: [],
                    recentEvents: [],
                    discoveredLocations: []
                };
            }

            // Determine environment and context
            const environment = getContextualEnvironment();

            // Parse action intent with much more variety
            if (action.match(/\b(look|examine|inspect|search|investigate|study|peer|scan)\b/)) {
                return generateExaminationResponse(environment, action);
            } else if (action.match(/\b(talk|speak|ask|question|inquire|converse|chat|discuss)\b/)) {
                return generateConversationResponse(action);
            } else if (action.match(/\b(attack|fight|strike|hit|combat|charge|assault|ambush)\b/)) {
                return generateCombatResponse();
            } else if (action.match(/\b(go|move|walk|travel|head|journey|venture|enter|exit|leave)\b/)) {
                return generateMovementResponse(action);
            } else if (action.match(/\b(take|grab|pick|acquire|collect|gather|loot|steal)\b/)) {
                return generateItemResponse();
            } else if (action.match(/\b(cast|spell|magic|conjure|invoke|summon)\b/)) {
                return generateSpellResponse();
            } else if (action.match(/\b(rest|sleep|camp|recover)\b/)) {
                return generateRestResponse();
            } else if (action.match(/\b(help|aid|assist|rescue|save)\b/)) {
                return generateHelpResponse();
            } else if (action.match(/\b(hide|sneak|stealth|creep)\b/)) {
                return generateStealthResponse();
            } else if (action.match(/\b(listen|hear|eavesdrop)\b/)) {
                return generateListeningResponse(environment);
            } else {
                return generateGeneralResponse(action);
            }
        }

        function generateExaminationResponse(environment, action) {
            const envDetail = random(DM_CONTENT.environmentDetails[environment]);
            const wisdom = currentCharacter.abilities.Wisdom;
            const intel = currentCharacter.abilities.Intelligence;

            // High Wisdom/Int characters notice more
            const noticeBonus = wisdom + intel > 30 ? 2 : wisdom + intel > 24 ? 1 : 0;

            const discoveries = [
                `${envDetail}. Your keen ${currentCharacter.race} senses detect ${random([
                    'scratch marks on the wall - something with claws passed through recently',
                    'a draft of air suggesting a hidden passage nearby',
                    'the faint scent of sulfur lingering in the air',
                    'disturbed dust patterns indicating recent activity',
                    'a loose stone in the wall that might conceal something'
                ])}`,

                `As a ${currentCharacter.class}, your training proves useful here. ${envDetail}. You discover ${random([
                    random(DM_CONTENT.treasures),
                    'tracks leading deeper into the unknown',
                    'evidence of a campsite - someone else has been here',
                    'strange markings that might be a warning... or a map',
                    'a hidden cache containing supplies and a cryptic note'
                ])}`,

                `${envDetail}. Your investigation reveals more than you expected: ${random([
                    'this place has been looted before, but hastily - perhaps the looters fled from something',
                    'signs of a struggle - dried blood stains the floor',
                    'fresh torch marks on the walls suggest others are here now',
                    'an intricate trap mechanism, currently disarmed but still dangerous-looking',
                    'writings in multiple languages, including one you don\'t recognize'
                ])}`,
            ];

            if (noticeBonus > 0) {
                discoveries.push(
                    `Your exceptional perception (Wisdom ${wisdom}, Intelligence ${intel}) allows you to notice what others would miss: ${random([
                        'a nearly invisible tripwire connected to a crossbow trap',
                        'a secret compartment built into the architecture',
                        'the subtle pattern of footprints - someone is trying not to be followed',
                        'a magical aura emanating from something nearby'
                    ])}. ${envDetail}.`
                );
            }

            // Sometimes trigger an event
            if (Math.random() < 0.25) {
                discoveries.push(
                    `${envDetail}. But your examination hasn't gone unnoticed - ${random([
                        'you hear footsteps approaching from the shadows',
                        'a distant alarm bell begins to ring',
                        'something stirs in the darkness ahead',
                        'you\'ve triggered something... you hear a mechanical click'
                    ])}`
                );
            }

            return random(discoveries);
        }

        function generateConversationResponse(action) {
            const npc = generateNPC();
            const charisma = currentCharacter.abilities.Charisma;
            const charismaMod = getAbilityModifier(charisma);

            // Store NPC for potential quest hooks
            if (!gameSession.context.knownNPCs.find(n => n.name === npc.name)) {
                gameSession.context.knownNPCs.push(npc);
            }

            // Generate quest hook 30% of the time
            const offersQuest = Math.random() < 0.3;
            const quest = offersQuest ? random(DM_CONTENT.questTypes) : null;

            const greetings = [
                `You encounter ${npc.name}, a ${npc.personality} ${random(['merchant', 'traveler', 'local', 'stranger', 'guard'])}. They ${npc.speech} as they address you.`,
                `${npc.name} notices your approach. The ${npc.personality} figure regards you with ${random(['curiosity', 'suspicion', 'interest', 'wariness', 'hope'])}.`,
                `A ${npc.personality} individual introduces themselves as ${npc.name}. They ${npc.speech}.`
            ];

            const dialogueOptions = [
                `"Well met, ${currentCharacter.name}. A ${currentCharacter.race} ${currentCharacter.class} - ${random([
                    'we don\'t see many of your kind here',
                    'impressive. The tales of your kind are legendary',
                    'you might be exactly what we need',
                    'interesting timing for someone like you to arrive'
                ])}."`,

                `"${random(['Greetings', 'Well met', 'Good day', 'Hail'])} adventurer. These are ${random([
                    'troubled times',
                    'strange days',
                    'dark hours',
                    'uncertain times'
                ])}. ${random([
                    'The roads are not safe',
                    'Danger lurks in unexpected places',
                    'Old evils are stirring',
                    'We need heroes now more than ever'
                ])}."`,

                `"A ${currentCharacter.class}? ${random([
                    'Your skills may prove valuable',
                    'Perhaps fate has brought you here',
                    'The gods smile upon our meeting',
                    'This is fortuitous indeed'
                ])}. ${random([
                    'There are matters that require someone of your talents',
                    'I have heard troubling rumors lately',
                    'Strange events have been occurring',
                    'Something evil stirs in these lands'
                ])}."`,
            ];

            let response = `${random(greetings)} ${random(dialogueOptions)}`;

            // Add quest offer if applicable
            if (quest) {
                const complication = random(DM_CONTENT.complications);
                response += `\n\n"${random([
                    'I have a proposition for you',
                    'Perhaps you can help with a matter',
                    'I need someone capable of handling a delicate situation',
                    'There\'s work for one such as you, if you\'re interested'
                ])}: ${quest.objective}. The reward would be ${quest.reward}, ${complication}. What say you?"`;

                // Store quest
                gameSession.context.activeQuests.push({
                    giver: npc.name,
                    type: quest.type,
                    objective: quest.objective,
                    reward: quest.reward,
                    active: false
                });
            }

            // High Charisma characters get additional information
            if (charismaMod > 1) {
                response += `\n\n(Your high Charisma (${charisma}) makes ${npc.name} more talkative. They add: "${random([
                    'Between you and me, there\'s more to this than I\'m letting on',
                    'I\'ve heard whispers of treasure in the old ruins',
                    'The local lord has been acting strangely of late',
                    'Trust no one in this town - not everyone is who they seem',
                    'There\'s an ancient map in the library that might interest you'
                ])}")`;
            }

            return response;
        }

        function generateCombatResponse() {
            const enemy = random(DM_CONTENT.enemies);
            const str = currentCharacter.abilities.Strength;
            const dex = currentCharacter.abilities.Dexterity;

            const initiativeRoll = rollDice(6).total + getAbilityModifier(dex);

            const combatIntros = [
                `${random([
                    'Without warning',
                    'From the shadows',
                    'With a battle cry',
                    'Suddenly',
                    'In a blur of motion'
                ])}, ${enemy.name} (${enemy.description}) ${enemy.tactics}!`,

                `Your ${currentCharacter.class} training kicks in as you face ${enemy.name}. The ${enemy.description} creature ${enemy.tactics}. ${random([
                    'You have moments to react',
                    'There\'s no time to hesitate',
                    'Your life depends on your next move',
                    'This will test your skills'
                ])}.`,

                `Combat erupts! ${enemy.name} - ${enemy.description} - confronts you. ${random([
                    'The creature appears wounded but dangerous',
                    'It moves with predatory grace',
                    'Madness gleams in its eyes',
                    'It seems to be guarding something'
                ])} and ${enemy.tactics}.`
            ];

            let response = random(combatIntros);

            // Add tactical information based on class
            if (currentCharacter.class.includes('Fighter') || currentCharacter.class.includes('Ranger')) {
                response += `\n\n(Your combat experience reveals: Threat level is ${enemy.threat}. ${random([
                    'Aim for weak points in its defense',
                    'Keep your guard up and watch for openings',
                    'Use your superior reach to your advantage',
                    'Circle to its blind side'
                ])})`;
            }

            // Add initiative result
            response += `\n\nYou rolled ${initiativeRoll} for initiative (d6 + Dex modifier).`;

            if (initiativeRoll >= 5) {
                response += ` You strike first! ${random([
                    'Describe your opening attack',
                    'What\'s your tactic?',
                    'How do you engage?',
                    'Make your move count'
                ])}!`;
            } else {
                response += ` Your opponent moves first - ${random([
                    'you must react quickly',
                    'brace yourself',
                    'defend yourself',
                    'prepare to counter'
                ])}!`;
            }

            // Chance for environmental factors
            if (Math.random() < 0.3) {
                response += ` ${random([
                    'The terrain here is treacherous - watch your footing',
                    'Your back is against a wall - limited room to maneuver',
                    'You spot cover nearby that you could use',
                    'The lighting is poor - both of you are hindered'
                ])}!`;
            }

            return response;
        }

        function generateMovementResponse(action) {
            const destinations = [...GREYHAWK_LOCATIONS, ...DM_CONTENT.locations.dungeon, ...DM_CONTENT.locations.wilderness];
            const newLocation = random(destinations);

            gameSession.context.discoveredLocations.push(newLocation);
            gameSession.location = newLocation;

            const travelEvents = [
                `As you journey toward ${newLocation}, ${random([
                    'you encounter a traveling merchant who shares news of the road',
                    'storm clouds gather ominously on the horizon',
                    'you spot riders in the distance - they haven\'t seen you yet',
                    'you find the remains of a recent campsite',
                    'an old hermit warns you of dangers ahead'
                ])}. `,

                `The path to ${newLocation} is ${random([
                    'longer and more arduous than expected',
                    'surprisingly peaceful and uneventful',
                    'fraught with signs of recent conflict',
                    'well-traveled and relatively safe',
                    'overgrown and barely visible'
                ])}. `,

                `Your ${currentCharacter.race} heritage serves you well on the journey to ${newLocation}. ${random([
                    'You avoid several potential dangers',
                    'You make better time than most travelers',
                    'You sense something following you',
                    'You discover a shortcut through the wilderness'
                ])}. `
            ];

            let response = random(travelEvents);

            response += `You arrive at ${newLocation}. ${random([
                `This ${random(['ancient', 'storied', 'mysterious', 'infamous', 'legendary'])} place is ${random([
                    'exactly as the stories described',
                    'more imposing than you imagined',
                    'strangely quiet and deserted',
                    'bustling with activity',
                    'showing signs of recent trouble'
                ])}.`,

                `The ${random(['settlement', 'location', 'area', 'region'])} of ${newLocation} ${random([
                    'has clearly seen better days',
                    'seems prosperous and well-defended',
                    'radiates an aura of ancient power',
                    'appears to be in a state of alert',
                    'welcomes travelers with open gates'
                ])}.`,

                `${newLocation} ${random([
                    'stands before you like something from legend',
                    'immediately sets your adventurer\'s instincts on edge',
                    'looks like the perfect place for opportunity... and danger',
                    'seems to hold secrets waiting to be uncovered'
                ])}.`
            ])}`;

            // Random encounter chance
            if (Math.random() < 0.25) {
                response += `\n\nHowever, as you enter ${newLocation}, ${random([
                    'guards stop you for questioning',
                    'you witness a commotion in the street',
                    'someone rushes up to you urgently',
                    'you notice you\'re being followed',
                    'an alarm suddenly rings out'
                ])}.`;
            }

            return response;
        }

        function generateItemResponse() {
            const item = random(DM_CONTENT.treasures);
            const dex = currentCharacter.abilities.Dexterity;

            let response = `${random([
                'Your keen eyes spot',
                'You discover',
                'Searching carefully, you find',
                'Hidden among the debris is',
                currentCharacter.class.includes('Thief') ? 'Your roguish instincts lead you to' : 'You come across'
            ])} ${item}. `;

            // Thieves get bonuses
            if (currentCharacter.class.includes('Thief') && Math.random() < 0.3) {
                response += `Your ${currentCharacter.class} training reveals ${random([
                    'a hidden compartment with additional coins',
                    'that this item is worth more than it appears',
                    'a secret marking indicating its true value',
                    'this belonged to someone important'
                ])}! `;
            }

            response += random([
                `You add it to your pack. ${random([
                    'It may prove invaluable',
                    'This could change everything',
                    'Such finds are what make adventuring worthwhile',
                    'The gods smile upon you this day'
                ])}.`,

                `${random([
                    'The item radiates subtle magic',
                    'This is clearly well-crafted',
                    'You sense this has history',
                    'Something about this feels significant'
                ])}. You secure it carefully.`,

                `${random([
                    'A fortunate discovery',
                    'Luck favors the bold',
                    'Your persistence pays off',
                    'Fate works in mysterious ways'
                ])}. ${random([
                    'You wonder what other treasures might be hidden nearby',
                    'Perhaps there\'s more to find here',
                    'This bodes well for your quest'
                ])}.`
            ]);

            return response;
        }

        function generateSpellResponse() {
            if (!currentCharacter.class.includes('Magic-User') &&
                !currentCharacter.class.includes('Cleric') &&
                !currentCharacter.class.includes('Druid') &&
                !currentCharacter.class.includes('Illusionist')) {
                return `As a ${currentCharacter.class}, you lack the arcane training for spellcasting. ${random([
                    'Perhaps a scroll or magical item could help',
                    'Your skills lie in other areas',
                    'Magic is not your forte - but that doesn\'t make you any less capable',
                    'Leave the magic to wizards; you have your own strengths'
                ])}.`;
            }

            const int = currentCharacter.abilities.Intelligence;
            const wis = currentCharacter.abilities.Wisdom;
            const relevantStat = currentCharacter.class.includes('Cleric') || currentCharacter.class.includes('Druid') ? wis : int;

            const effects = [
                `Your ${currentCharacter.class} powers surge through you! ${random([
                    'Eldritch energy crackles and hisses',
                    'The air itself warps and shimmers',
                    'Ancient words of power echo with terrible force',
                    'Reality bends to your trained will',
                    'The weave of magic responds eagerly to your command'
                ])}. `,

                `Drawing upon your ${relevantStat > 15 ? 'considerable' : 'trained'} magical abilities (${currentCharacter.class.includes('Cleric') ? 'Wisdom' : 'Intelligence'} ${relevantStat}), you ${random([
                    'weave the spell with practiced precision',
                    'channel raw magical force',
                    'invoke powers beyond mortal ken',
                    'tap into the fundamental forces of creation'
                ])}. `,

                `The spell ${random([
                    'manifests exactly as intended',
                    'surges forth with unexpected potency',
                    'takes shape with beautiful precision',
                    'erupts in a display of mystical power'
                ])}! ${random([
                    'Your magical training serves you well',
                    'The power of the arcane flows through you',
                    'Such is the might of a true spellcaster',
                    'This is why you studied the mystical arts'
                ])}. `
            ];

            let response = random(effects);

            // High Int/Wis characters get extra effect
            if (relevantStat > 16) {
                response += `(Your exceptional ${currentCharacter.class.includes('Cleric') ? 'Wisdom' : 'Intelligence'} allows for ${random([
                    'enhanced spell duration',
                    'increased potency',
                    'better control and precision',
                    'additional magical effects'
                ])})`;
            }

            return response;
        }

        function generateRestResponse() {
            const con = currentCharacter.abilities.Constitution;
            const conMod = getAbilityModifier(con);
            const healAmount = Math.max(1, rollDice(4).total + conMod);

            return `You ${random([
                'find a relatively safe spot to rest',
                'make camp and tend to your wounds',
                'take a moment to catch your breath and recover',
                'settle in for some much-needed rest'
            ])}. ${random([
                'The respite does you good',
                'Your body begins to mend',
                'You feel your strength returning',
                'Rest revitalizes you'
            ])}. You recover ${healAmount} HP (d4 + Con modifier). ${random([
                'You remain vigilant even as you rest',
                'The night passes without incident',
                'You wake feeling refreshed',
                'Your wounds begin to heal'
            ])}.`;
        }

        function generateStealthResponse() {
            const dex = currentCharacter.abilities.Dexterity;
            const stealthRoll = rollDice(20).total + getAbilityModifier(dex);

            let response = `You attempt to ${random([
                'move silently through the shadows',
                'blend into your surroundings',
                'avoid detection',
                'sneak past unnoticed'
            ])}. `;

            if (currentCharacter.class.includes('Thief') || currentCharacter.class.includes('Assassin')) {
                response += `Your ${currentCharacter.class} training gives you an advantage. `;
            }

            response += `(Stealth check: ${stealthRoll} = d20 + Dex modifier)`;

            if (stealthRoll >= 15) {
                response += ` You succeed brilliantly! ${random([
                    'You move like a ghost',
                    'Not even the most alert guard would spot you',
                    'You are one with the shadows',
                    'Your movements are practically invisible'
                ])}.`;
            } else if (stealthRoll >= 10) {
                response += ` You manage reasonable stealth, but ${random([
                    'you must still be cautious',
                    'one wrong move could give you away',
                    'you\'re not entirely undetectable',
                    'careful observation might reveal you'
                ])}.`;
            } else {
                response += ` Unfortunately, ${random([
                    'you make more noise than intended',
                    'your movements attract attention',
                    'you\'re not as subtle as you hoped',
                    'someone may have noticed you'
                ])}.`;
            }

            return response;
        }

        function generateListeningResponse(environment) {
            const wis = currentCharacter.abilities.Wisdom;
            const listenRoll = rollDice(20).total + getAbilityModifier(wis);

            let response = `You pause and listen carefully... (Perception: ${listenRoll} = d20 + Wis modifier)\n\n`;

            if (listenRoll >= 15) {
                response += `Your keen hearing picks up ${random([
                    'hushed voices discussing something in another room',
                    'the scrape of metal on stone - something moving nearby',
                    'water flowing somewhere below you',
                    'the distinctive sound of coins being counted',
                    'breathing - someone or something is very close',
                    'footsteps approaching from the east',
                    'chanting in a language you don\'t recognize'
                ])}. ${random([
                    'This information could prove valuable',
                    'You\'ve learned something important',
                    'Your vigilance has paid off',
                    'This changes things'
                ])}.`;
            } else if (listenRoll >= 10) {
                response += `You hear ${random([
                    'vague sounds that are hard to identify',
                    'the usual ambient noises of ' + environment,
                    'something, but you can\'t quite make it out',
                    'distant sounds that might or might not be significant'
                ])}. ${random([
                    'Nothing seems immediately threatening',
                    'Perhaps if you listened more carefully',
                    'The acoustics here make it difficult to discern details'
                ])}.`;
            } else {
                response += `${random([
                    'The sounds are confusing and indistinct',
                    'You strain to hear but catch nothing useful',
                    'The ambient noise makes it hard to focus',
                    'Your ears pick up nothing of note'
                ])}. ${random([
                    'Perhaps silence isn\'t always golden',
                    'Sometimes discretion is the better part of valor',
                    'You\'ll have to rely on other senses'
                ])}.`;
            }

            return response;
        }

        function generateHelpResponse() {
            const cha = currentCharacter.abilities.Charisma;

            return `You ${random([
                'rush to offer assistance',
                'step forward to help',
                'lend your aid to those in need',
                'answer the call for help'
            ])}. ${random([
                `Your ${currentCharacter.alignment} nature compels you to act`,
                `As a ${currentCharacter.class}, you're no stranger to helping others`,
                `This is what heroes do`,
                `You couldn't stand by and do nothing`
            ])}. ${random([
                'Your assistance is appreciated and remembered',
                'Good deeds have a way of coming back around',
                'You\'ve made an ally this day',
                'Sometimes being a hero means simply helping those in need'
            ])}. ${cha > 14 ? `(Your Charisma of ${cha} makes your aid even more effective and appreciated)` : ''}`;
        }

        function generateGeneralResponse(action) {
            const responses = [
                `You attempt your action. ${random([
                    'Your ' + currentCharacter.class + ' instincts guide you',
                    'Drawing on your experience, you proceed carefully',
                    'This requires focus and determination',
                    'You commit fully to this course of action'
                ])}. ${random([
                    'The outcome will reveal itself shortly',
                    'Only time will tell if this was wise',
                    'Your actions will have consequences',
                    'What happens next could change everything'
                ])}.`,

                `As a ${currentCharacter.race} ${currentCharacter.class}, you ${random([
                    'approach this challenge with confidence',
                    'draw upon your unique perspective',
                    'use your training to guide your actions',
                    'trust your instincts'
                ])}. ${random([
                    'The situation develops in unexpected ways',
                    'Things proceed, though not entirely as planned',
                    'Your action sets events in motion',
                    'The consequences of your choice become apparent'
                ])}.`,

                `You proceed with determination. ${random([
                    'The path of adventure is never straightforward',
                    'Every choice shapes your legend',
                    'This is the life you chose',
                    'Such is the way of heroes'
                ])}. ${random([
                    'What will you do next?',
                    'The story continues',
                    'Your journey is far from over',
                    'More challenges await'
                ])}.`
            ];

            return random(responses);
        }

        function endSession() {
            if (confirm('End this session? Your progress will be saved.')) {
                // Auto-sync to cloud if enabled
                autoSyncIfEnabled();
                showMainMenu();
            }
        }

        // ========================================
        // SETTINGS
        // ========================================

        function showSettings() {
            const users = loadFromStorage('users');
            const settings = users[currentUser].settings;

            document.getElementById('dmStyle').value = settings.dmStyle;
            document.getElementById('difficulty').value = settings.difficulty;
            document.getElementById('setting').value = settings.setting;

            // Load AI settings
            document.getElementById('useAI').checked = settings.useAI || false;
            document.getElementById('aiModel').value = settings.aiModel || 'claude-3-5-sonnet-20241022';

            // Load admin API key
            const globalKey = loadFromStorage('globalApiKey') || '';
            document.getElementById('adminApiKey').value = globalKey;

            // Update AI status message
            const statusEl = document.getElementById('aiStatus');
            if (globalKey) {
                statusEl.textContent = '‚úÖ AI available (global API key configured)';
                statusEl.style.color = 'var(--success)';
            } else {
                statusEl.textContent = '‚ö†Ô∏è AI requires admin to configure API key';
                statusEl.style.color = 'var(--secondary)';
            }

            showScreen('settingsScreen');
        }

        function saveSettings() {
            const users = loadFromStorage('users');
            const useAI = document.getElementById('useAI').checked;

            users[currentUser].settings = {
                dmStyle: document.getElementById('dmStyle').value,
                difficulty: document.getElementById('difficulty').value,
                setting: document.getElementById('setting').value,
                useAI: useAI,
                aiModel: document.getElementById('aiModel').value
            };

            // Update global AI config
            AI_CONFIG.useAI = useAI;
            AI_CONFIG.model = document.getElementById('aiModel').value;

            saveToStorage('users', users);

            const effectiveKey = getEffectiveApiKey();
            alert(useAI && effectiveKey ? 'Settings saved! AI DM enabled.' : 'Settings saved!');
            showMainMenu();
        }

        function checkAdminAccess(event) {
            event.preventDefault();

            const adminPassword = loadFromStorage('adminPassword');
            const details = document.getElementById('adminSection');

            // If already open, allow it to close
            if (details.hasAttribute('open')) {
                return true;
            }

            // First time setup - no password set yet
            if (!adminPassword) {
                const newPassword = prompt('Set up admin password (this is your first time):');
                if (!newPassword) {
                    return false;
                }
                const confirmPassword = prompt('Confirm admin password:');
                if (newPassword !== confirmPassword) {
                    alert('Passwords do not match!');
                    return false;
                }
                if (newPassword.length < 4) {
                    alert('Password must be at least 4 characters');
                    return false;
                }
                saveToStorage('adminPassword', newPassword);
                alert('Admin password set! You can now access admin settings.');
                details.setAttribute('open', '');
                return false;
            }

            // Verify password
            const inputPassword = prompt('Enter admin password:');
            if (inputPassword !== adminPassword) {
                alert('Incorrect admin password!');
                return false;
            }

            // Allow opening and load admin settings
            details.setAttribute('open', '');
            loadAdminSettings();
            return false;
        }

        function loadAdminSettings() {
            // Load global API key
            const globalApiKey = loadFromStorage('globalApiKey') || '';
            document.getElementById('adminApiKey').value = globalApiKey;

            // Load cloud sync settings
            const cloudSyncEnabled = loadFromStorage('adminCloudSyncEnabled') || false;
            const githubToken = loadFromStorage('adminGithubToken') || '';
            const gistId = loadFromStorage('adminGistId') || '';

            document.getElementById('adminEnableCloudSync').checked = cloudSyncEnabled;
            document.getElementById('adminGithubToken').value = githubToken;
            document.getElementById('adminGistId').value = gistId;
        }

        function changeAdminPassword() {
            const currentPassword = loadFromStorage('adminPassword');
            if (!currentPassword) {
                alert('No admin password is set');
                return;
            }

            const inputCurrent = prompt('Enter current admin password:');
            if (inputCurrent !== currentPassword) {
                alert('Incorrect current password!');
                return;
            }

            const newPassword = prompt('Enter new admin password:');
            if (!newPassword || newPassword.length < 4) {
                alert('Password must be at least 4 characters');
                return;
            }

            const confirmPassword = prompt('Confirm new admin password:');
            if (newPassword !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }

            saveToStorage('adminPassword', newPassword);
            alert('Admin password updated successfully!');
        }

        function saveAdminApiKey() {
            const apiKey = document.getElementById('adminApiKey').value.trim();

            if (!apiKey) {
                if (confirm('Remove global API key? This will disable AI for all users.')) {
                    localStorage.removeItem('globalApiKey');
                    alert('Global API key removed');
                    showSettings(); // Refresh to update status
                }
                return;
            }

            // Validate format
            if (!apiKey.startsWith('sk-ant-')) {
                alert('Invalid API key format. Should start with sk-ant-');
                return;
            }

            saveToStorage('globalApiKey', apiKey);
            alert('Global API key saved! All users can now use AI DM.');
            showSettings(); // Refresh to update status
        }

        function saveAdminCloudSettings() {
            const enabled = document.getElementById('adminEnableCloudSync').checked;
            const token = document.getElementById('adminGithubToken').value.trim();
            const gistId = document.getElementById('adminGistId').value.trim();

            // Save settings
            saveToStorage('adminCloudSyncEnabled', enabled);
            saveToStorage('adminGithubToken', token);
            saveToStorage('adminGistId', gistId);

            alert('Cloud sync settings saved!\n\n' +
                  (enabled && token ? 'Auto-sync is now enabled for all users.' :
                   'Auto-sync is disabled. Configure token to enable.'));

            // Auto-sync if enabled and token is provided
            if (enabled && token) {
                adminSyncNow(true);
            }
        }

        async function adminSyncNow(silent = false) {
            const token = loadFromStorage('adminGithubToken');
            if (!token) {
                alert('Please configure GitHub token in admin settings');
                return;
            }

            try {
                const users = loadFromStorage('users');
                const data = JSON.stringify(users, null, 2);
                const gistData = {
                    description: 'Solo Dungeon Master - All Users Data',
                    public: false,
                    files: {
                        'solo-dm-save.json': {
                            content: data
                        }
                    }
                };

                let gistId = loadFromStorage('adminGistId');
                let response;

                if (gistId) {
                    // Update existing gist
                    response = await fetch(`https://api.github.com/gists/${gistId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Accept': 'application/vnd.github+json',
                            'X-GitHub-Api-Version': '2022-11-28'
                        },
                        body: JSON.stringify(gistData)
                    });
                } else {
                    // Create new gist
                    response = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Accept': 'application/vnd.github+json',
                            'X-GitHub-Api-Version': '2022-11-28'
                        },
                        body: JSON.stringify(gistData)
                    });
                }

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('GitHub API Error:', response.status, errorData);
                    throw new Error(`GitHub API Error ${response.status}: ${errorData.message || 'Unknown error'}`);
                }

                const gist = await response.json();

                // Save gist ID if it's new
                if (!gistId) {
                    saveToStorage('adminGistId', gist.id);
                    document.getElementById('adminGistId').value = gist.id;
                }

                if (!silent) {
                    alert('All user data synced to cloud successfully!');
                }
            } catch (error) {
                console.error('Cloud sync error:', error);
                alert(`Failed to sync to cloud:\n\n${error.message}\n\nCheck console for details.`);
            }
        }

        async function adminLoadFromCloud() {
            const token = loadFromStorage('adminGithubToken');
            const gistId = loadFromStorage('adminGistId');

            if (!token) {
                alert('Please configure GitHub token in admin settings');
                return;
            }

            if (!gistId) {
                alert('No Gist ID found. Please sync data first to create a gist.');
                return;
            }

            try {
                const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github+json',
                        'X-GitHub-Api-Version': '2022-11-28'
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('GitHub API Error:', response.status, errorData);
                    throw new Error(`GitHub API Error ${response.status}: ${errorData.message || 'Unknown error'}`);
                }

                const gist = await response.json();
                const content = gist.files['solo-dm-save.json'].content;
                const cloudData = JSON.parse(content);

                // Replace local data with cloud data
                saveToStorage('users', cloudData);

                alert('All user data loaded from cloud successfully!');

                // If not logged in, show login screen
                if (!currentUser) {
                    showLogin();
                }
            } catch (error) {
                console.error('Cloud load error:', error);
                alert(`Failed to load from cloud:\n\n${error.message}\n\nCheck console for details.`);
            }
        }

        // Silent version for automatic loading on login
        async function adminLoadFromCloudSilent() {
            const token = loadFromStorage('adminGithubToken');
            const gistId = loadFromStorage('adminGistId');

            if (!token || !gistId) {
                return; // Silently skip if not configured
            }

            const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/vnd.github+json',
                    'X-GitHub-Api-Version': '2022-11-28'
                }
            });

            if (!response.ok) {
                throw new Error(`GitHub API Error ${response.status}`);
            }

            const gist = await response.json();
            const content = gist.files['solo-dm-save.json'].content;
            const cloudData = JSON.parse(content);

            // Replace local data with cloud data
            saveToStorage('users', cloudData);
            console.log('[Cloud Sync] Data loaded from cloud successfully');
        }

        function exportData() {
            const users = loadFromStorage('users');
            if (!users || Object.keys(users).length === 0) {
                alert('No data to export');
                return;
            }

            const dataStr = JSON.stringify(users, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `dungeon-master-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert('Data exported successfully! Save this file to backup or transfer your data.');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    const existingUsers = loadFromStorage('users') || {};

                    // Merge imported data with existing
                    const mergedUsers = { ...existingUsers, ...importedData };
                    saveToStorage('users', mergedUsers);

                    alert(`Data imported successfully! ${Object.keys(importedData).length} user(s) added/updated.`);

                    // Reset file input
                    event.target.value = '';
                } catch (error) {
                    alert('Error importing data. Please make sure the file is a valid backup.');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
        }

        // Auto-sync after game sessions using admin-configured cloud sync
        function autoSyncIfEnabled() {
            const enabled = loadFromStorage('adminCloudSyncEnabled');
            const token = loadFromStorage('adminGithubToken');
            const gistId = loadFromStorage('adminGistId');

            if (enabled && token && gistId) {
                adminSyncNow(true).catch(err => console.error('Auto-sync failed:', err));
            }
        }

        // ========================================
        // INITIALIZATION
        // ========================================

        window.addEventListener('DOMContentLoaded', async function() {
            console.log('[Init] Page loaded, checking for cloud sync...');

            // ALWAYS load from cloud first if configured (ensures data persists across code pushes)
            const cloudSyncEnabled = loadFromStorage('adminCloudSyncEnabled');
            const githubToken = loadFromStorage('adminGithubToken');
            const gistId = loadFromStorage('adminGistId');

            if (cloudSyncEnabled && githubToken && gistId) {
                try {
                    console.log('[Init] Cloud sync configured - loading latest data...');
                    await adminLoadFromCloudSilent();
                    console.log('[Init] ‚úì Data loaded from cloud successfully');
                } catch (error) {
                    console.warn('[Init] Could not load from cloud, using local data:', error.message);
                }
            } else {
                console.log('[Init] Cloud sync not configured, using local data only');
                console.log('[Init] ‚ö†Ô∏è To enable persistence: Admin ‚Üí Settings ‚Üí Configure Cloud Sync');
            }

            // Check if user is already logged in
            const savedUser = loadFromStorage('currentUser');
            if (savedUser) {
                const users = loadFromStorage('users');
                if (users && users[savedUser]) {
                    currentUser = savedUser;
                    console.log('[Init] Auto-login user:', savedUser);
                    showMainMenu();
                } else {
                    console.log('[Init] Saved user not found, showing login');
                    showLogin();
                }
            } else {
                console.log('[Init] No saved user, showing login');
                showLogin();
            }

            // Handle Enter key in action input
            document.getElementById('playerAction').addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    submitAction();
                }
            });
        });
    </script>
</body>
</html>
